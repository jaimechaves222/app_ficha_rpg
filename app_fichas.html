import os, zipfile, textwrap, re, json, math, datetime

full_html = r"""<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caos Controlado ‚Äì Jaime Giovane</title>

<style>
:root{--gold:#d4af37;--black:#000;--white:#f5f5f5}
body{margin:0;font-family:Arial;background:var(--black);color:var(--white)}
header{background:linear-gradient(90deg,var(--gold),#111);padding:20px;text-align:center;border-bottom:2px solid var(--gold)}
h1{margin:0;color:#000}
h2,h3{color:var(--gold)}
.container{padding:20px}
button{width:100%;padding:14px;margin-bottom:10px;background:var(--gold);color:#000;border:none;border-radius:8px;font-weight:bold}
button.secondary{background:#111;color:var(--white);border:1px solid var(--gold)}
button.danger{background:#400;color:#fff;border:1px solid #a00}
.page{display:none}.page.active{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px}
.char{
 background:#111;border:2px solid var(--gold);border-radius:50%;
 width:120px;height:120px;text-align:center;padding-top:10px;cursor:pointer
}
.char img{width:70px;height:70px;border-radius:50%;object-fit:cover;border:2px solid var(--gold)}
.card{background:#111;border:1px solid var(--gold);border-radius:10px;padding:15px;margin-bottom:15px;cursor:pointer}
input,textarea,select{
 width:100%;background:#000;color:var(--white);
 border:1px solid var(--gold);border-radius:6px;padding:10px;margin-bottom:10px
}
img.big{width:100%;max-height:320px;object-fit:cover;border-radius:8px;margin-bottom:10px}
.locked{opacity:.5}

/* VIDA */
.lifeWrap{margin:10px 0 15px}
.lifeTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px}
.lifeBar{
 width:100%;height:18px;border:1px solid var(--gold);border-radius:999px;overflow:hidden;background:#000
}
.lifeFill{height:100%;width:0%}
.lifeControls{display:flex;gap:10px;margin-top:10px}
.lifeControls button{width:100%;padding:12px;margin:0}
.smallNote{opacity:.8;font-size:12px;margin-top:6px}

/* ATRIBUTOS */
.attrWrap{margin-top:10px}
.attrRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:8px 0}
.attrName{font-weight:bold}
.attrBtns{display:flex;gap:8px;align-items:center}
.attrBtns button{width:auto;padding:8px 12px;margin:0}
.attrVal{min-width:26px;text-align:center;font-weight:bold;border:1px solid var(--gold);border-radius:8px;padding:6px 10px;background:#000}
hr.sep{border:none;border-top:1px solid #222;margin:12px 0}
</style>
</head>

<body>
<header>
<h1>Caos Controlado</h1>
<p>Vers√£o de Teste ‚Äì Jaime Giovane</p>
</header>

<div class="container">

<!-- HOME -->
<div class="page active" id="home">
<button onclick="go('campanhas')">üé≤ Entrar em Campanha</button>
<button class="secondary" onclick="loginMestre()">üîí √Årea do Mestre</button>
</div>

<!-- CAMPANHAS PLAYER -->
<div class="page" id="campanhas">
<h2>Campanhas</h2>
<div id="listaCampanhas"></div>
<button class="secondary" onclick="go('home')">‚¨Ö Voltar</button>
</div>

<!-- MENU CAMPANHA -->
<div class="page" id="sistema">
<h2 id="campanhaNome"></h2>
<button onclick="go('personagens')">üé≠ Personagens</button>
<button onclick="go('abas')">üóÇÔ∏è Abas da Campanha</button>
<button class="secondary" onclick="go('campanhas')">‚¨Ö Sair</button>
</div>

<!-- PERSONAGENS PLAYER -->
<div class="page" id="personagens">
<h2>Personagens</h2>
<div class="grid" id="listaPersonagens"></div>
<button class="secondary" onclick="go('sistema')">‚¨Ö Voltar</button>
</div>

<!-- FICHA -->
<div class="page" id="ficha">
<h2 id="fichaNome"></h2>
<img id="fichaFoto" class="big">

<!-- ATRIBUTOS (VIEW) -->
<div class="card" style="cursor:default">
  <b>üß© Atributos</b>
  <div id="fichaAtributos" class="attrWrap"></div>
  <div class="smallNote">Todos come√ßam em 1. M√°ximo por atributo: 3.</div>
</div>

<!-- VIDA (VIEW + AJUSTE) -->
<div class="card" style="cursor:default">
  <b>‚ù§Ô∏è Vida</b>
  <div class="lifeWrap">
    <div class="lifeTop">
      <div><span id="vidaAtualTxt">0</span>/<span id="vidaMaxTxt">0</span></div>
      <div id="vidaPctTxt" class="smallNote"></div>
    </div>
    <div class="lifeBar">
      <div id="vidaFill" class="lifeFill"></div>
    </div>
    <div class="lifeControls">
      <button class="secondary" onclick="ajustarVida(-1)">-1</button>
      <button onclick="ajustarVida(+1)">+1</button>
    </div>
    <div class="smallNote">Dica: isso salva automaticamente na campanha (localStorage).</div>
  </div>
</div>

<div class="card"><b onclick="toggle('historia')">üìú Hist√≥ria</b><p id="fichaHistoria" style="display:none"></p></div>
<div class="card"><b onclick="toggle('pericias')">üéØ Per√≠cias</b><ul id="fichaPericias" style="display:none"></ul></div>
<div class="card"><b onclick="toggle('armas')">‚öîÔ∏è Armas</b><ul id="fichaArmas" style="display:none"></ul></div>
<button class="secondary" onclick="go('personagens')">‚¨Ö Voltar</button>
</div>

<!-- ABAS PLAYER -->
<div class="page" id="abas">
<h2>Abas da Campanha</h2>
<div id="listaAbas"></div>
<button class="secondary" onclick="go('sistema')">‚¨Ö Voltar</button>
</div>

<!-- ABA VIEW -->
<div class="page" id="abaView">
<h2 id="abaTitulo"></h2>
<img id="abaImg" class="big">
<p id="abaTexto"></p>
<button class="secondary" onclick="go('abas')">‚¨Ö Voltar</button>
</div>

<!-- MESTRE -->
<div class="page" id="mestre">
<h2>√Årea do Mestre</h2>
<select id="campanhaSelect"></select>
<button onclick="entrarMestre()">Entrar</button>

<h3>Criar campanha</h3>
<input id="novaCampanha" placeholder="Nome da campanha">
<button onclick="criarCampanha()">Criar</button>
<button class="secondary" onclick="go('home')">‚¨Ö Voltar</button>
</div>

<!-- PAINEL MESTRE -->
<div class="page" id="painelMestre">
<h2 id="mestreCampanha"></h2>
<button onclick="go('editarPersonagens')">‚úèÔ∏è Editar Personagens</button>
<button onclick="go('editarAbas')">üóÇÔ∏è Editar Abas</button>
<button class="danger" onclick="apagarCampanha()">üóëÔ∏è Apagar Campanha</button>
<button class="secondary" onclick="go('campanhas')">‚¨Ö Sair</button>
</div>

<!-- EDITAR PERSONAGENS -->
<div class="page" id="editarPersonagens">
<h2>Editar Personagens</h2>
<select id="personagemSelect"></select>
<input id="pNome" placeholder="Nome">
<textarea id="pHistoria" placeholder="Hist√≥ria"></textarea>

<h3>üß© Atributos</h3>
<div class="smallNote">Come√ßam em 1. Voc√™ tem <b>3 pontos</b> para distribuir. M√°ximo por atributo: <b>3</b>.</div>
<div id="attrEditor" class="attrWrap"></div>
<div class="smallNote">Pontos restantes: <b><span id="attrRestantes">3</span></b></div>

<hr class="sep">

<!-- VIDA (MESTRE DEFINE) -->
<h3>‚ù§Ô∏è Vida</h3>
<input id="pVidaMax" type="number" min="0" step="1" placeholder="Vida m√°xima (inicial)">
<input id="pVidaAtual" type="number" min="0" step="1" placeholder="Vida atual">
<div class="smallNote">A vida atual √© limitada entre 0 e a vida m√°xima.</div>

<textarea id="pPericias" placeholder="Per√≠cias (uma por linha)"></textarea>
<textarea id="pArmas" placeholder="Armas (uma por linha)"></textarea>
<input type="file" accept="image/*" onchange="uploadFotoPersonagem(event)">
<button onclick="salvarPersonagem()">Salvar</button>
<button class="secondary" onclick="go('painelMestre')">‚¨Ö Voltar</button>
</div>

<!-- EDITAR ABAS -->
<div class="page" id="editarAbas">
<h2>Editar Abas da Campanha</h2>
<select id="abaSelect"></select>
<input id="aTitulo" placeholder="T√≠tulo">
<textarea id="aTexto" placeholder="Texto"></textarea>
<input type="file" accept="image/*" onchange="uploadFotoAba(event)">
<input id="aSenha" placeholder="Senha da Aba (opcional)">
<button onclick="salvarAba()">Salvar Aba</button>
<button class="secondary" onclick="go('painelMestre')">‚¨Ö Voltar</button>
</div>

</div>

<script>
const SENHA_MESTRE="animestre";
const ATRIBUTOS = ["For√ßa","Agilidade","Intelecto","Presen√ßa","Vigor"];
const PONTOS_DISTRIBUIR = 3;
const ATTR_MIN = 1;
const ATTR_MAX = 3;

let campanhas=JSON.parse(localStorage.getItem("septem_campaigns"))||{};
let atual=null;

// guarda o √≠ndice do personagem que est√° aberto na ficha
let fichaIndex=null;

function baseAtributos(){
  const o={};
  ATRIBUTOS.forEach(a=>o[a]=1);
  return o;
}

function ensurePersonagemDefaults(p){
  // Vida
  if(typeof p.vidaMax!=="number") p.vidaMax=10;
  if(typeof p.vidaAtual!=="number") p.vidaAtual=p.vidaMax;

  // Atributos
  if(!p.atributos || typeof p.atributos!=="object"){
    p.atributos = baseAtributos();
  } else {
    ATRIBUTOS.forEach(a=>{
      const v = parseInt(p.atributos[a],10);
      p.atributos[a] = Number.isFinite(v) ? clamp(v, ATTR_MIN, ATTR_MAX) : ATTR_MIN;
    });
  }
}

function pontosRestantesAtributos(atributos){
  const usados = ATRIBUTOS.reduce((acc,a)=> acc + (clamp(parseInt(atributos[a]||ATTR_MIN,10), ATTR_MIN, ATTR_MAX) - ATTR_MIN), 0);
  return clamp(PONTOS_DISTRIBUIR - usados, 0, PONTOS_DISTRIBUIR);
}

function template(){
 return {
  personagens:[
   {nome:"Jogador I",historia:"",pericias:[],armas:[],foto:"",vidaMax:10,vidaAtual:10,atributos:baseAtributos()},
   {nome:"Jogador II",historia:"",pericias:[],armas:[],foto:"",vidaMax:10,vidaAtual:10,atributos:baseAtributos()},
   {nome:"Jogador III",historia:"",pericias:[],armas:[],foto:"",vidaMax:10,vidaAtual:10,atributos:baseAtributos()},
   {nome:"Jogador IV",historia:"",pericias:[],armas:[],foto:"",vidaMax:10,vidaAtual:10,atributos:baseAtributos()},
   {nome:"Jogador V",historia:"",pericias:[],armas:[],foto:"",vidaMax:10,vidaAtual:10,atributos:baseAtributos()},
   {nome:"Jogador VI",historia:"",pericias:[],armas:[],foto:"",vidaMax:10,vidaAtual:10,atributos:baseAtributos()},
   {nome:"Jogador VII",historia:"",pericias:[],armas:[],foto:"",vidaMax:10,vidaAtual:10,atributos:baseAtributos()}
  ],
  abas:{
   cenarios:{title:"Cen√°rios",text:"",img:"",senha:""},
   npcs:{title:"NPCs",text:"",img:"",senha:""},
   pistas:{title:"Pistas",text:"",img:"",senha:""},
   eventos:{title:"Eventos",text:"",img:"",senha:""},
   segredos:{title:"Segredos",text:"",img:"",senha:""}
  }
 };
}

function save(){localStorage.setItem("septem_campaigns",JSON.stringify(campanhas));}

function go(p){
 document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
 document.getElementById(p).classList.add("active");
 if(p==="campanhas")renderCampanhas();
 if(p==="personagens")renderChars();
 if(p==="abas")renderAbas();
}

function renderCampanhas(){
 listaCampanhas.innerHTML="";
 Object.keys(campanhas).forEach(k=>{
  const d=document.createElement("div");
  d.className="card";
  d.textContent=k;
  d.onclick=()=>{atual=k;campanhaNome.innerText=k;go('sistema')};
  listaCampanhas.appendChild(d);
 });
}

function renderChars(){
 listaPersonagens.innerHTML="";
 campanhas[atual].personagens.forEach((p,i)=>{
  ensurePersonagemDefaults(p);
  const d=document.createElement("div");
  d.className="char";
  d.innerHTML=`<img src="${p.foto||'https://via.placeholder.com/100'}"><div>${p.nome}</div>`;
  d.onclick=()=>abrirFicha(i);
  listaPersonagens.appendChild(d);
 });
 save();
}

function abrirFicha(i){
 fichaIndex=i;
 const p=campanhas[atual].personagens[i];
 ensurePersonagemDefaults(p);

 fichaNome.innerText=p.nome;
 fichaFoto.src=p.foto||"";
 fichaHistoria.innerText=p.historia;
 fichaPericias.innerHTML=p.pericias.map(x=>"<li>"+x+"</li>").join("");
 fichaArmas.innerHTML=p.armas.map(x=>"<li>"+x+"</li>").join("");

 renderFichaAtributos(p.atributos);
 atualizarBarraVida();
 save();
 go("ficha");
}

function renderFichaAtributos(atributos){
 fichaAtributos.innerHTML="";
 ATRIBUTOS.forEach(a=>{
   const row=document.createElement("div");
   row.className="attrRow";
   row.innerHTML=`<div class="attrName">${a}</div><div class="attrVal">${atributos[a]||1}</div>`;
   fichaAtributos.appendChild(row);
 });
}

function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

function atualizarBarraVida(){
 if(fichaIndex===null) return;
 const p=campanhas[atual].personagens[fichaIndex];
 ensurePersonagemDefaults(p);

 const max = Math.max(0, parseInt(p.vidaMax||0,10));
 const cur = clamp(parseInt(p.vidaAtual||0,10), 0, max);

 // garante consist√™ncia
 p.vidaMax=max;
 p.vidaAtual=cur;

 const pct = (max<=0) ? 0 : Math.round((cur/max)*100);

 vidaAtualTxt.innerText=cur;
 vidaMaxTxt.innerText=max;
 vidaPctTxt.innerText = max<=0 ? "" : (pct + "%");

 vidaFill.style.width = pct + "%";
 save();
}

function ajustarVida(delta){
 if(fichaIndex===null) return;
 const p=campanhas[atual].personagens[fichaIndex];
 ensurePersonagemDefaults(p);
 const max = Math.max(0, parseInt(p.vidaMax||0,10));
 const cur = clamp(parseInt(p.vidaAtual||0,10) + delta, 0, max);
 p.vidaAtual = cur;
 atualizarBarraVida();
}

function renderAbas(){
 listaAbas.innerHTML="";
 Object.keys(campanhas[atual].abas).forEach(k=>{
  const a=campanhas[atual].abas[k];
  const d=document.createElement("div");
  d.className="card "+(a.senha?"locked":"");
  d.innerHTML=`${a.title} ${a.senha?"üîí":""}`;
  d.onclick=()=>abrirAba(k);
  listaAbas.appendChild(d);
 });
}

function abrirAba(k){
 const a=campanhas[atual].abas[k];
 if(a.senha){
  const s=prompt("Senha da aba:");
  if(s!==a.senha)return alert("Senha incorreta");
 }
 abaTitulo.innerText=a.title;
 abaTexto.innerText=a.text;
 abaImg.src=a.img||"";
 go("abaView");
}

function loginMestre(){
 const s=prompt("Senha do mestre:");
 if(s===SENHA_MESTRE){
  campanhaSelect.innerHTML="";
  Object.keys(campanhas).forEach(k=>campanhaSelect.innerHTML+=`<option>${k}</option>`);
  go("mestre");
 } else alert("Senha incorreta");
}

function criarCampanha(){
 const n=novaCampanha.value.trim();
 if(!n)return;
 campanhas[n]=JSON.parse(JSON.stringify(template()));
 save();
 novaCampanha.value="";
 alert("Campanha criada");
}

function entrarMestre(){
 atual=campanhaSelect.value;
 mestreCampanha.innerText=atual;
 carregarEdicao();
 go("painelMestre");
}

function apagarCampanha(){
 const c=prompt("Digite APAGAR para confirmar");
 if(c==="APAGAR"){
  delete campanhas[atual];
  save();
  atual=null;
  alert("Campanha apagada");
  go("campanhas");
 }
}

function carregarEdicao(){
 personagemSelect.innerHTML="";
 campanhas[atual].personagens.forEach((p,i)=>{
   ensurePersonagemDefaults(p);
   personagemSelect.innerHTML+=`<option value="${i}">${p.nome}</option>`;
 });
 personagemSelect.onchange=loadPersonagem;
 loadPersonagem();

 abaSelect.innerHTML="";
 Object.keys(campanhas[atual].abas).forEach(k=>abaSelect.innerHTML+=`<option value="${k}">${campanhas[atual].abas[k].title}</option>`);
 abaSelect.onchange=loadAba;
 loadAba();
 save();
}

function renderAttrEditor(p){
 ensurePersonagemDefaults(p);
 attrEditor.innerHTML="";
 const restantes = pontosRestantesAtributos(p.atributos);
 attrRestantes.innerText = restantes;

 ATRIBUTOS.forEach(a=>{
   const row=document.createElement("div");
   row.className="attrRow";
   const v = p.atributos[a] ?? 1;
   row.innerHTML=`
     <div class="attrName">${a}</div>
     <div class="attrBtns">
       <button class="secondary" type="button" onclick="alterarAtributo('${a}',-1)">-</button>
       <div class="attrVal" id="val_${a}">${v}</div>
       <button type="button" onclick="alterarAtributo('${a}',+1)">+</button>
     </div>
   `;
   attrEditor.appendChild(row);
 });
}

function alterarAtributo(attr,delta){
 const p=campanhas[atual].personagens[personagemSelect.value];
 ensurePersonagemDefaults(p);
 const cur = clamp(parseInt(p.atributos[attr]||ATTR_MIN,10), ATTR_MIN, ATTR_MAX);
 let restantes = pontosRestantesAtributos(p.atributos);

 if(delta>0){
   if(restantes<=0) return;
   if(cur>=ATTR_MAX) return;
   p.atributos[attr]=cur+1;
 } else {
   if(cur<=ATTR_MIN) return;
   p.atributos[attr]=cur-1;
 }
 // Recalcula e atualiza UI
 restantes = pontosRestantesAtributos(p.atributos);
 attrRestantes.innerText = restantes;
 document.getElementById("val_"+attr).innerText = p.atributos[attr];

 save();

 // Se a ficha estiver aberta no mesmo personagem, atualiza tamb√©m
 if(fichaIndex===parseInt(personagemSelect.value,10)){
   renderFichaAtributos(p.atributos);
 }
}

function loadPersonagem(){
 const p=campanhas[atual].personagens[personagemSelect.value];
 ensurePersonagemDefaults(p);

 pNome.value=p.nome;
 pHistoria.value=p.historia;
 pPericias.value=p.pericias.join("\n");
 pArmas.value=p.armas.join("\n");

 pVidaMax.value = p.vidaMax;
 pVidaAtual.value = p.vidaAtual;

 renderAttrEditor(p);
}

function salvarPersonagem(){
 const p=campanhas[atual].personagens[personagemSelect.value];
 ensurePersonagemDefaults(p);

 p.nome=pNome.value;
 p.historia=pHistoria.value;

 // Vida
 const max = Math.max(0, parseInt(pVidaMax.value||0,10));
 const cur = clamp(parseInt(pVidaAtual.value||0,10), 0, max);
 p.vidaMax = max;
 p.vidaAtual = cur;

 // Atributos: garante limites e pontos
 ATRIBUTOS.forEach(a=>{
   const v = clamp(parseInt(p.atributos[a]||ATTR_MIN,10), ATTR_MIN, ATTR_MAX);
   p.atributos[a]=v;
 });
 const restantes = pontosRestantesAtributos(p.atributos);
 if(restantes<0){
   alert("Atributos inv√°lidos (pontos excedidos). Ajuste antes de salvar.");
   return;
 }

 // Listas
 p.pericias=pPericias.value.split("\n").map(x=>x.trim()).filter(Boolean);
 p.armas=pArmas.value.split("\n").map(x=>x.trim()).filter(Boolean);

 save();
 alert("Personagem salvo");
 renderChars();
}

function uploadFotoPersonagem(e){
 const r=new FileReader();
 r.onload=()=>{
  campanhas[atual].personagens[personagemSelect.value].foto=r.result;
  save();
 };
 r.readAsDataURL(e.target.files[0]);
}

function loadAba(){
 const a=campanhas[atual].abas[abaSelect.value];
 aTitulo.value=a.title;
 aTexto.value=a.text;
 aSenha.value=a.senha;
}

function salvarAba(){
 const a=campanhas[atual].abas[abaSelect.value];
 a.title=aTitulo.value;
 a.text=aTexto.value;
 a.senha=aSenha.value;
 save();
 alert("Aba salva");
 renderAbas();
}

function uploadFotoAba(e){
 const r=new FileReader();
 r.onload=()=>{
  campanhas[atual].abas[abaSelect.value].img=r.result;
  save();
 };
 r.readAsDataURL(e.target.files[0]);
}

function toggle(sec){
 const map={historia:fichaHistoria,pericias:fichaPericias,armas:fichaArmas};
 map[sec].style.display=map[sec].style.display==="none"?"block":"none";
}
</script>

</body>
</html>

